# 医療機関システム (hos_sys) - コード改善による開発効率向上

---

## **概要**

DB修正の為、システム全体のコードを調査する中で、**現在の設計・実装を改善することで、チームの開発効率と保守性を大幅に向上できる機会**が多数発見された。
これらの改善により、以下のような**ポジティブな変化**が期待できる：

- **日々の開発作業の効率化**
- **バグ修正時間の大幅短縮**
- **新機能開発のスピードアップ**
- **チームメンバー間の引継ぎが簡単に**
- **システム全体の理解が容易に**

現在の問題点と、それを改善することで得られる具体的なメリットを列挙する。

---

## **改善による開発チームへの具体的メリット**

### **日々の作業効率の改善**
※個人的な意見です
| 改善項目 | 現在の状況 | 改善後の効果 |
|---------|----------|-------------|
| **関数の理解・修正** | **数時間～数日** | **30分～1時間** |
| **バグ原因の特定** | **半日～数日** | **30分～2時間** |
| **新機能の追加** | **1週間～1ヶ月** | **1日～1週間** |
| **コードレビュー** | **困難・時間がかかる** | **迅速・的確に実施可能** |
| **新メンバーの学習** | **1ヶ月～3ヶ月** | **1週間～2週間** |

### **開発について**

| 改善項目 | 現在の状況 | 改善後の効果 |
|---------|----------|-------------|
| **コードの理解しやすさ** | **理解困難** | **統一・整理を行うため、理解可能** |
| **デバッグ作業** | **原因特定が困難** | **問題箇所を素早く特定** |

---

## **技術改善の具体的提案**

### **第1段階: 関数分割とコード整理** (期間: 1-2ヶ月)

#### **改善内容**
1. **巨大関数の分割**: 70パラメータの関数を10個程度の理解しやすい関数に分割
2. **重複コード除去**: 重複した関数やコードを統一
3. **エラーハンドリング統一**: 統一されたエラー処理による予測可能な動作
4. **命名規則統一**: 誰が見ても理解できる変数・関数名

#### **チームへのメリット**
- ✅ **コードレビューが30分で完了** (現在: 数時間)
- ✅ **バグ修正時間が50%短縮** 
- ✅ **新機能開発効率が向上**
- ✅ **チームメンバー全員がコードを理解可能**

#### **実装のポイント**
- 一度に全てを変更せず、修正が必要な箇所から段階的に改善
- 既存機能への影響を最小化

※実装はまとめて行う

---

### **第2段階: データベース構造の改善** (期間: 2-3ヶ月)

#### **改善内容**
1. **正規化設計**: 100カラムのテーブルを理解しやすい関連テーブルに分割
2. **マスタテーブル化**: 診療科情報を独立したテーブルとして管理
3. **クエリの単純化**: 複雑なSQLを理解しやすい形に変更
4. **命名規則統一**: 誰が見ても理解できるテーブル名・カラム名へ変更

#### **チームへのメリット**
- ✅ **データ取得処理が200%高速化**
- ✅ **SQLクエリが理解しやすく、修正が容易**
- ✅ **データの整合性が自動的に保たれる**

#### **実装のポイント**
- 新しいテーブル構造を先に作成し、段階的に移行
- 既存データの安全な移行手順を確立
- 移行期間中も通常業務に影響なし

※実装はまとめて行う

---

### **第3段階: モダンな開発環境の構築** (期間: 2-4ヶ月)

#### **改善内容**
1. **レイヤー分離**: 見た目・処理・データアクセスを明確に分離
2. **モジュール化**: 機能ごとに独立した構造で管理
3. **テスト自動化**: 修正時の動作確認を自動化

#### **チームへのメリット**
- ✅ **新機能開発が従来の1/3の時間で完了**
- ✅ **バグの早期発見により修正時間が激減**
- ✅ **新しいメンバーでも1週間で開発に参加可能**
- ✅ **将来の技術変更に柔軟に対応可能****システム保守費用の大幅増大**

---

現在のシステム設計・実装における具体的な問題点と改善提案についてまとめる。

---

## **現在のシステム構造における課題**

### 1. **巨大すぎる関数による開発効率の低下** 🔴 最重要

#### **現在の状況**
システムの中核となる関数が**異常に巨大化**し、開発作業に支障をきたしている：

- **1つの関数に70個以上のパラメータ**
- **600行を超える処理が1つの関数に集約**
- **複数の異なる機能が混在**

#### **具体例**
```php
function get_result($dbh,$hos_name,$college,$univ,$medical,$nantoua,$nanseia,
$takahashia,$maniwaa,$tuyamaa,$hos_diva,$hos_divb,$hos_divc,$hos_divd,
$hos_dive,$area,$ina,$hos_cda,$hosname2,$hos_cdb,$anta,$kyokai,$intro,
$r_intro,$contact,$training,$bed,$bednum,$bednum_ika,$iji,$ijiin,
// ...さらに40個以上のパラメータ(他の場所から受け取る値の受け皿)が続く
){
    // 600行以上の処理...
}
```

#### **改善により得られるメリット**
- ✅ **コードレビューが劇的に簡単になる**: 小さな関数なら10分で理解可能
- ✅ **バグ修正が安心して行える**: 影響範囲が明確で予測可能
- ✅ **新しい機能追加が容易**: 既存機能に影響せずに開発可能
- ✅ **チーム開発が効率化**: 複数人で並行して作業可能

---

### 2. **データベース設計による開発の非効率性** 🔴 最重要

#### **現在の状況**
データベース設計が**正規化されておらず**、開発作業に以下の支障が存在する：

- **1つのテーブルに100以上のカラム**が混在
- **診療科ごとに個別カラムが作成**される非効率な構造
- **データの整合性を保つ仕組みが不十分**
- **カラム名が分かりづらい**

#### **具体例**
```sql
-- mainテーブルの一部（実際は100以上のカラム）
CREATE TABLE main (
    hos_cd VARCHAR(10),
    hos_name VARCHAR(255),
    int_int TINYINT,      -- 内科・内科
    int_dig TINYINT,      -- 内科・消化器科
    int_cir TINYINT,      -- 内科・循環器科
    int_neu TINYINT,      -- 内科・神経内科
    // 診療科ごとに個別カラムが100個以上...
);
```

#### **改善により得られるメリット**
- ✅ **新しい診療科の追加が超簡単**: 設定ファイルの1行追加だけで完了
- ✅ **処理速度が大幅向上**: データ検索・更新が高速化
- ✅ **SQLクエリが理解しやすく**: 複雑な条件分岐が不要
- ✅ **統計データの作成が容易**: 集計処理がシンプルに

---

### 3. **プログラム構造による開発効率の低下** 🟠 高重要

#### **現在の状況**
プログラム全体の構造が**適切な設計原則に従っておらず**、以下の開発阻害要因が存在する：

- **同じ処理が30箇所以上に重複**して記載
- **ビジネスロジックと表示処理が混在**
- **エラーハンドリングが統一されていない**

#### **具体例**
```php
// 同じSQLパターンが30回以上繰り返し
SELECT SUM(intr) FROM intro AS A 
WHERE A.hos_cd=main.hos_cd 
AND A.year= :year 
AND A.fie_cd='int_int'  -- 診療科ごとに同じパターン

// ビジネスロジックと表示が混在
function getData() {
    $sql = "SELECT ...";  // データ取得
    echo "<tr><td>";      // HTML出力
    if($error) {          // エラー処理
        return false;     // 戻り値
    }
}
```

#### **改善により得られるメリット**
- ✅ **修正は1箇所だけで完了**: 重複コードを解消し、効率的な保守
- ✅ **テストが簡単に実行可能**: 機能ごとに独立したテストが可能
- ✅ **エラー原因の特定が容易**: 統一されたエラー処理で問題箇所を即座に特定
- ✅ **新しい機能の追加が安全**: 既存機能への影響を気にせず開発可能

---

### 4. **技術的負債による学習コストの増大** 🟠 高重要

#### **現在の状況**
長期間にわたる**場当たり的な修正**により、新しいメンバーや引継ぎに以下の課題が挙げられる：

- **命名規則が統一されていない**
- **設定値がコード内に直接記載**
- **古いプログラミング手法と新しい手法が混在**

#### **具体例**
```php
// 命名規則の不統一
$hos_cd          // アンダースコア記法
$hosName         // キャメルケース  
$nantoua         // 日本語ローマ字
$fie_cd          // 意味不明な略語

// 設定値のハードコーディング
if($var['ins']==='0'){ echo '附属病院'; }
elseif($var['ins']==='1'){ echo '総合医療センター';}
elseif($var['ins']==='2'){ echo 'その他'; }

// フロントエンドの技術混在
$(document).ready(function() {      // jQuery
document.getElementById('btn')      // 素のJavaScript
```

#### **改善により得られるメリット**
- ✅ **新しいメンバーがすぐに理解可能**: 1週間で基本的な開発に参加可能
- ✅ **引継ぎ作業が超簡単**: ドキュメントを読むだけで理解可能
- ✅ **統一されたコードで迷わない**: どのファイルも同じパターンで理解しやすい
- ✅ **設定変更が設定ファイルだけで完了**: コードを触らずに設定変更可能

---

##  **改善によるチーム開発効率の向上**

### 1. **日々の開発作業の劇的な改善** 🟠 中重要

#### **現在の状況**
システムの中核部分が**過度に複雑化**しており、以下の開発阻害要因が存在する：

- **1つの処理に70以上の設定項目**が必要
- **600行を超える巨大なプログラム**が存在
- **修正時の影響範囲が予測不可能**

#### **改善後の開発体験**
- ✅ **コードレビューが容易になる**: 小さくて理解しやすい関数
- ✅ **バグ修正が安心してできる**: 影響範囲が明確
- ✅ **新機能追加がスムーズ**: 既存機能に影響しない設計
- ✅ **複数人での並行開発が可能**: 機能ごとに分離された構造

---

### 2. **データ操作の効率化と高速化** 🟠 中重要

#### **現在の状況**
データベースの設計が**非効率的**で、以下の開発阻害要因があります：

- **1つのテーブルに100以上の項目**が混在
- **診療科追加時にシステム全体を変更**する必要
- **データの整合性を保つことが困難**

#### **改善後の開発体験**
- ✅ **新しい診療科の追加が容易**: SQLでデータをDBへ保存するのみ
- ✅ **データ検索・更新が高速化**: 最適化されたクエリで処理時間短縮
- ✅ **SQLの理解が容易**: シンプルで直感的なクエリ
- ✅ **データ不整合の心配がゼロ**: 自動的に整合性が保たれる設計

---

### 3. **エラー対応とデバッグの効率化** 🟡 中重要

#### **現在の状況**
エラー処理が**統一されておらず**、以下の開発阻害要因が存在する：

- **エラー処理方法が箇所によって異なる**
- **エラー情報のログ記録が不十分**
- **ユーザーへのエラーメッセージが不適切**

#### **具体例**
```php
// 箇所A: try-catch使用
try {
    $result = someFunction();
} catch (Exception $e) {
    // エラー処理
}

// 箇所B: 戻り値チェック
if ($result === false) {
    echo "エラーが発生しました";
}

// 箇所C: エラー処理なし
$data = riskyFunction();  // エラーが発生する可能性があるが処理なし
```

#### **改善後の開発体験**
- ✅ **エラー原因が即座にわかる**: 統一されたログでピンポイント特定
- ✅ **デバッグ時間が大幅短縮**: 問題箇所を素早く特定
- ✅ **ユーザーにわかりやすいメッセージ**: 統一されたエラーメッセージ
- ✅ **システムの安定性向上**: 予期しないエラーでもシステム継続

---

### 4. **処理性能の向上と快適な開発環境** 🟡 中重要

#### **現在の状況**
効率的でない処理により**パフォーマンス問題**が発生し、開発時の確認に時間がかかる：

- **N+1問題**: ループ内でのデータベースアクセス
- **非効率なSQL**: 最適化されていないクエリ
- **重複処理**: 同じデータを何度も取得

#### **具体例**
```php
// N+1問題の例
$hospitals = getHospitalList();           // 1回のクエリ
foreach($hospitals as $hospital) {
    $details = getHospitalDetails($hospital['id']); // N回のクエリ
}

// 非効率なSQL
SELECT * FROM main WHERE hos_cd IN (
    SELECT hos_cd FROM sub_table WHERE condition = 'value'
);
// JOINを使用すべき
```

#### **改善後の開発体験**
- ✅ **開発時の動作確認が快適**: 画面の表示が瞬時に完了
- ✅ **テスト実行が高速**: 自動テストの実行時間が短縮
- ✅ **データ処理が効率的**: 最適化されたクエリで高速処理
- ✅ **スケーラビリティ確保**: データ量が増えても性能維持

---


## ✅ **改善作業のチェックリスト**

### **今すぐ始められる改善** (1週間以内)
- [ ] **巨大関数の分析**: まずは70パラメータ関数の処理内容を理解・文書化
- [ ] **重複コード箇所の特定**: 同じ処理パターンをリストアップ
- [ ] **エラー発生箇所の調査**: 現在のエラーハンドリング方法を整理
- [ ] **チーム内での改善方針共有**: 改善の方向性をチーム全体で合意

### **段階的な改善作業** (1-3ヶ月)
- [ ] **小さな関数から分割開始**: リスクの少ない部分から実践
- [ ] **共通処理の関数化**: 最も使用頻度の高い重複処理から統一
- [ ] **命名規則の統一**: 新規作成・修正時に統一ルールを適用
- [ ] **簡単なテストケース作成**: 主要機能の動作確認テスト

### **本格的な構造改善** (3-6ヶ月)
- [ ] **データベーステーブルの見直し設計**
- [ ] **機能別モジュール化の実施**
- [ ] **自動テスト環境の構築**
- [ ] **開発・デプロイプロセスの改善**

---

## **改善によって実現される理想の開発環境**

### **チーム全体のスキルアップ**
- ✅ **きれいなコード構造**: 読みやすく理解しやすいコードでプログラミングスキル向上
- ✅ **モダンな開発手法**: 最新のベストプラクティスを実践できる環境
- ✅ **安心してチャレンジ**: テスト環境があるので新しい技術を試しやすい
- ✅ **効率的な学習**: システム全体を理解しやすく、技術的な成長が加速

### **日々の開発作業の質向上**
- ✅ **集中できる環境**: 複雑な調査に時間を取られず、本質的な開発に集中
- ✅ **創造的な作業**: 保守作業が効率化され、新しい機能開発に時間を割ける
- ✅ **達成感のある仕事**: 問題解決が迅速で、成果が見えやすい
- ✅ **ストレスフリーな開発**: エラー対応や調査作業によるストレス軽減

---
